# NetShark 当前问题总结

## 问题 1: 数据重复
**现象**: 相同时间戳的包出现2次
```
17:33:24.693  192.168.2.130  TCP  192.168.2.33:9001  103B  -
17:33:24.693  192.168.2.130  TCP  192.168.2.33:9001  103B  -  (重复)
```

**可能原因**:
1. 同一个包被回调函数调用了两次
2. 队列中的数据被重复发送
3. WebSocket 连接不稳定导致重发

## 问题 2: Latency 显示为 `-`
**现象**: 
- **后端日志**: `[LATENCY] Response matched! ... -> 0ms` ✅
- **前端显示**: 全部显示 `-` ❌

**原因分析**:
虽然后端计算出了延迟（0ms, 1ms），但前端收到的数据中 latency 字段可能：
1. 被覆盖为 `-`
2. 没有正确传递
3. TCP ACK 包的延迟太短（0-1ms）不是真正的应用层延迟

## 问题 3: 延迟计算逻辑问题
**TCP 通信特点**:
- TCP 是双向的，每个方向都有大量包
- ACK 包返回很快（0-1ms）
- 真正的应用层请求-响应才有有意义的延迟

**当前逻辑问题**:
- 把所有 TCP 包都配对计算延迟
- 实际上应该只对应用层的请求-响应计算延迟

## 下一步诊断

### 方案 A: 简化问题 - 先显示所有包的方向
暂时移除延迟计算，专注于：
1. 解决数据重复
2. 在前端显示包的方向（出站/入站）
3. 确保数据正确传输

### 方案 B: 改进延迟逻辑
- 只对有 payload 的包计算延迟
- 忽略纯 ACK 包
- 只匹配相同大小范围的请求-响应对

## 建议
我建议先执行**方案 A**，确保基础功能正常，然后再优化延迟计算。

您希望我：
1. 先修复数据重复和传输问题？
2. 还是直接优化延迟计算逻辑？
