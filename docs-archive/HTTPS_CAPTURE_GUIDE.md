# HTTPS 抓包功能使用指南

## 🔒 **功能概述**

NetShark 现在支持两种抓包模式：

| 模式 | 图标 | 适用场景 | 是否需要配置代理 |
|------|------|---------|----------------|
| **TCP 抓包** | 📦 | 抓取原始网络流量 | ❌ 无需配置 |
| **HTTPS 代理** | 🔒 | 解密 HTTPS 加密流量 | ✅ 需配置代理 |

---

## 📦 **TCP 抓包模式（默认）**

### 工作原理
- 使用 WinPcap/Npcap 直接抓取网络层数据包
- 可以看到 TCP 握手、HTTP 明文请求等
- **无法解密 HTTPS 流量**（只能看到加密数据）

### 使用方法
1. 选择目标进程
2. 填写服务器 IP（可选，用于过滤）
3. 点击"开始会话"

---

## 🔒 **HTTPS 代理模式**

### 工作原理
- 启动本地 MITM 代理服务器（127.0.0.1:8888）
- 目标应用通过此代理发送请求
- 代理解密 HTTPS 流量后转发给 NetShark

### 使用步骤

#### 1. 选择 HTTPS 模式
在配置界面，选择"🔒 HTTPS 代理"模式

#### 2. 点击开始会话
会弹出提示：
```
🔒 HTTPS 代理已启动！

代理地址: http://127.0.0.1:8888

请在目标应用中配置此代理地址。
首次使用需安装 CA 证书。
```

#### 3. 配置目标应用使用代理

**Windows 系统代理：**
1. 打开 设置 → 网络和 Internet → 代理
2. 开启"使用代理服务器"
3. 地址：`127.0.0.1`，端口：`8888`

**浏览器代理（以 Chrome 为例）：**
1. 使用扩展：SwitchyOmega
2. 新建代理配置：HTTP `127.0.0.1:8888`
3. 切换到此配置

**命令行程序：**
```bash
# Windows CMD
set HTTP_PROXY=http://127.0.0.1:8888
set HTTPS_PROXY=http://127.0.0.1:8888

# PowerShell
$env:HTTP_PROXY="http://127.0.0.1:8888"
$env:HTTPS_PROXY="http://127.0.0.1:8888"
```

**curl 示例：**
```bash
curl -x http://127.0.0.1:8888 https://api.example.com
```

#### 4. 安装 CA 证书（首次使用）

为了让代理能够解密 HTTPS 流量，需要安装代理的 CA 证书：

**自动安装（需管理员权限）：**
- 调用 API：`POST /api/https/install-cert`

**手动安装：**
1. 证书位置：`C:\Users\<用户名>\.mitmproxy\mitmproxy-ca-cert.cer`
2. 双击证书文件
3. 选择"安装证书"
4. 选择"本地计算机" → 下一步
5. 选择"将所有证书放入下列存储" → 浏览 → "受信任的根证书颁发机构"
6. 完成安装

---

## ⚠️ **注意事项**

### 安全风险
- MITM 代理会解密所有经过它的 HTTPS 流量
- **仅在开发/测试环境使用**
- 不要在公共网络或生产环境使用

### 证书固定 (Certificate Pinning)
- 某些应用（如银行 App）会验证证书
- 这些应用无法通过 MITM 代理
- 会显示"证书错误"或拒绝连接

### 性能影响
- HTTPS 代理会增加少量延迟
- 适合调试，不建议长时间开启

---

## 🔧 **故障排除**

### 问题：HTTPS 网站显示证书错误
**原因**：未安装 CA 证书
**解决**：按上述步骤安装 mitmproxy CA 证书

### 问题：某些应用拒绝连接
**原因**：应用使用了证书固定
**解决**：这类应用无法解密，请使用 TCP 模式

### 问题：代理无法启动
**原因**：端口 8888 被占用
**解决**：关闭占用进程，或修改代理端口

### 问题：抓不到流量
**检查**：
1. 应用是否配置了代理？
2. 代理是否正在运行？（状态栏显示绿色）
3. CA 证书是否已安装？

---

## 📊 **API 参考**

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/https/start` | POST | 启动 HTTPS 代理 |
| `/api/https/stop` | POST | 停止 HTTPS 代理 |
| `/api/https/status` | GET | 获取代理状态 |
| `/api/https/install-cert` | POST | 安装 CA 证书 |
| `/ws/https` | WebSocket | 实时流量推送 |

---

## 🎯 **最佳实践**

1. **开发调试**：使用 HTTPS 模式抓取 API 请求
2. **性能分析**：使用 TCP 模式分析网络层问题
3. **安全测试**：临时启用，测试后立即关闭
